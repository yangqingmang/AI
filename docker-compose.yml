services:
  # 1. 向量数据库服务 (ChromaDB)
  chroma-server:
    image: chromadb/chroma:latest
    container_name: eb_chroma
    volumes:
      - ../chroma_db:/chroma/chroma
    ports:
      - "8001:8000" # Map host 8001 to container 8000 (Internal)
    restart: unless-stopped
    environment:
      - ALLOW_RESET=TRUE

  # 2. 后端 API 服务 (FastAPI)
  backend:
    build: .
    image: enterprise-brain-backend:v1.3
    container_name: eb_backend
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000
    volumes:
      - ../data:/app/data
      - ../chat_history.db:/app/chat_history.db # Persist chat history
    ports:
      - "8000:8000"
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL}
      - LLM_MODEL_NAME=${LLM_MODEL_NAME}
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
      - HF_ENDPOINT=https://hf-mirror.com
    depends_on:
      - chroma-server
    restart: unless-stopped

  # 3. 前端界面 (Streamlit)
  frontend:
    build: .
    image: enterprise-brain-frontend:v1.3
    container_name: eb_frontend
    command: streamlit run src/app.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "8501:8501"
    environment:
      - API_BASE_URL=http://backend:8000/api/v1
    depends_on:
      - backend
    restart: unless-stopped

